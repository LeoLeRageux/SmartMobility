<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>Point anim√© sur trajectoire</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src='https://api.mapbox.com/mapbox.js/v3.3.0/mapbox.js'></script>
<link href='https://api.mapbox.com/mapbox.js/v3.3.0/mapbox.css' rel='stylesheet' />
<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap4.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.20/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

<script>
	$(document).ready(function() {
	var table = $('#myTable').DataTable({
		"columnDefs": [ {
        "targets": -1,
        "data": null,
        "defaultContent": '<button>Add To Path</button> <button>Edit path</button> <button>Delete Path</button>'
    } ]
	});
	
	$('#myTable tbody').on( 'click', 'button', function () {
		savedChoice = $(this).closest('tr').index();
		if(this.innerHTML == "Add To Path"){
			addMarkersToSelectedPath();
		} else if (this.innerHTML == "Edit path"){
			editSelectedPath()
		} else if (this.innerHTML == "Delete Path"){
			deleteSelectedPath();
		} else {
			changePathName(savedChoice);
		}
	} );

	});
</script>
<!-- animatedMarker plugin -->
<script src="AnimatedMarker.js"></script>
</head>
<body>
<center>
<p id="info"> --- </p>
<div id="menu">
<b>Map type :</b>
<input
id="streets-v11"
type="radio"
name="rtoggle"
value="streets"
checked="checked"
/>
<label for="streets-v11">Streets</label>
<input id="light-v10" type="radio" name="rtoggle" value="light" />
<label for="light-v10">Light</label>
<input id="dark-v10" type="radio" name="rtoggle" value="dark" />
<label for="dark-v10">Dark</label>
<input id="outdoors-v11" type="radio" name="rtoggle" value="outdoors" />
<label for="outdoors-v11">Outdoors</label>
<input id="satellite-v9" type="radio" name="rtoggle" value="satellite" />
<label for="satellite-v9">Satellite</label>
</div>

<div id='map' style='width: 1590px; height: 500px;' onKeyPress="if(editMode==false){addPointer();}"></div>
<div id="stopEditingButton" style="display: none">
	<button onclick="stopEditMode()">Stop editing</button>
</div>
<div id="stopAddingButton" style="display: none">
	<button onclick="stopAddMode()">Stop adding markers</button>
</div>
</center>
<div id="allExceptEditButton" style="display: block">
<center>

<p> Simulation speed : <button id="simSpeed" onclick="changeSpeed()">Normal</button></p>
<p>Transportation Mode : <button id="transMode" onclick="changeTransportationMode()">Driving</button></p>
<button onclick="createNewRoute()">Draw a new path</button>
<button onclick="showSettings()">Settings</button>

<label for="color-path-select">Change a specific marker's icon :</label>
<select name="marker-icon" id="marker-icon-select" onchange="if(this.value != ''){changeIcon(simulationBias-(mergedRoutes.length-this.value));}">
	<option value="">--Choose an icon--</option>
</select>
<button onclick="downloadPaths()">Download Paths</button>
<button onclick="downloadPaths(true); redirectToDL();">Upload Paths To Google Drive</button>
<button onclick="showPathManagement()">Path Management</button>

<div id="settings" style="display: none">
	<label for="color-marker-select">Markers color :</label>
	<select name="colors-marker" id="color-marker-select" onchange="changeMarkersColor()">
		<option value="#3388ff">--Choose a color--</option> <!-- default color -->
		<option value="blue">Blue</option>
		<option value="red">Red</option>
		<option value="green">Green</option>
	</select>
	<label for="color-path-select">Paths color :</label>
	<select name="colors-path" id="color-path-select" onchange="changePathsColor()">
		<option value="#3388ff">--Choose a color--</option> <!-- default color -->
		<option value="blue">Blue</option>
		<option value="red">Red</option>
		<option value="green">Green</option>
	</select>
</div>
<div id="path-management" style="display: none">
	<div class="table-responsive">
    <table class="table table-striped table-bordered" id="myTable">
        <thead>
            <tr class="table-primary">
                <th>Number</th>
                <th>Name</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
		</tbody>
    </table>
	</div>
</div>
<br/>
<button onclick="simulateTrajectory()">Start Simulation</button>
</center>
</div>
<script>
function redirectToDL(){
	location.href = 'http://localhost/GDrive/index2.html?fileToGD='+stringToDownload;
}
L.mapbox.accessToken = 'pk.eyJ1IjoibGVvbHIiLCJhIjoiY2s5bXB1ZnUzMDZzZjNmbnR6OXVzemF0byJ9.MeB8qySF0KJn0WHkOOZj3Q';
var map = L.mapbox.map('map')
    .setView([40, -74.50], 9)
    .addLayer(L.mapbox.styleLayer('mapbox://styles/mapbox/streets-v11'));

var layerList = document.getElementById('menu');
var inputs = layerList.getElementsByTagName('input');
 
function switchLayer(layer) {
	var layerId = layer.target.id;
	map.addLayer(L.mapbox.styleLayer('mapbox://styles/mapbox/' + layerId));
}
 
for (var i = 0; i < inputs.length; i++) {
	inputs[i].onclick = switchLayer;
}

var transportationMode = "driving";
function changeTransportationMode(){
	var bInner = document.getElementById("transMode").innerHTML;
	if(bInner == "Driving"){
		document.getElementById("transMode").innerHTML = "Cycling";
		transportationMode = "cycling";
	} else {
		document.getElementById("transMode").innerHTML = "Driving";
		transportationMode = "driving";
	}
}
var pathNames = [];
function hightlight(pathId){
	// get the polylines of the selected path
	var tempPolyArray = []; // temporary array to store the polylines before changing colors
	var tempMarkerArray = []; // same with markers
	for(var i=0; i<polylines.length; i++){
		if(polylineIds[i] == savedChoice){
			tempPolyArray.push(polylines[i]);
		}
	}
	for(var i=0; i<markers.length; i++){
		if(markersPathIds[i] == savedChoice){
			tempMarkerArray.push(markers[i]);
		}
	}
	if(editMode || addMode){
		tempMarkerArray[0].setIcon(greenIcon);
	} else {
		tempMarkerArray[0].setIcon(blueIcon);
	}
	for(var i=0; i<tempPolyArray.length; i++){
		if(editMode || addMode){ // change the path color
			tempPolyArray[i].setStyle({
				color: "#13c242"
			});
		} else { // reset the path's color
			tempPolyArray[i].setStyle({
				color: "#3388ff"
			});
		}
	}
}

var editMode = false;
var indexes = [];
var savedChoice;
function editSelectedPath(){
	editMode = true;
	hightlight(savedChoice);
	document.getElementById("stopEditingButton").style.display = "block";
	document.getElementById("allExceptEditButton").style.display = "none";
		for(var i=0; i<markers.length; i++){
			if(markersPathIds[i] == savedChoice){ // get the markers of the chosenPath
				markers[i].dragging.enable();
				markers[i].on('dragend', function(event) {
					var length = polylines.length
					removePolylines(savedChoice);
					editLatLngs(savedChoice);
					// rebuild the path using the markers
					for(var i=0; i<length+1; i++){
						if(markersPathIds[i] == savedChoice && markersPathIds[i+1] == savedChoice){
								callApi(markers[i].getLatLng().lng, markers[i].getLatLng().lat, markers[i+1].getLatLng().lng, markers[i+1].getLatLng().lat, transportationMode);
						}
					}
				});
			}
		}
}
function editLatLngs(savedChoice){
	// marker 0 => latLng 0 & 1, marker 1 => latLng 2 & 3, marker 2 => latLng 4 & 5,...
	for(var i=0; i<=markers.length; i++){
		if(markersPathIds[i] == savedChoice){
			latLng[i+i] = markers[i].getLatLng().lat.toString();
			latLng[i+i+1] = markers[i].getLatLng().lng.toString();
		}
	}
}
function removePolylines(savedChoice){
	for(var j=0; j<polylines.length; j++){
		if(polylineIds[j] == savedChoice){
			polylines[j].remove();
		}
	}
	var index = polylineIds.indexOf(savedChoice);
	while(index != -1){
		polylines.splice(index, 1);
		polylineIds.splice(index, 1);
		index = polylineIds.indexOf(savedChoice);
	}
}

function removeMarkers(savedChoice){
	for(var j=0; j<markers.length; j++){
		if(markersPathIds[j] == savedChoice){
			markers[j].remove();
		}
	}
	var index = markersPathIds.indexOf(savedChoice);
	while(index != -1){
		markers.splice(index, 1);
		markersPathIds.splice(index, 1);
		latLng.splice(index, 2);
		if(markersPathIds.indexOf(savedChoice) != -1){
			route-=2;
		}
		index = markersPathIds.indexOf(savedChoice);
	}
	i = 0;
}
var deletedPath = false;
function deleteSelectedPath(){
	removePolylines(savedChoice);
	removeMarkers(savedChoice);
	deletedPath = true; // this value is set to true so the function callApi isn't called at the first point
	pathNames.splice(savedChoice, 1);
	editPathsList();
}

var tempRoute;
var tempMarkerPathId;
var markersArray = [];
var nbOfMarkersBeforePath = 0;
var lastMarker;
var addMode = false;
function addMarkersToSelectedPath(){
	var markersArray = [];
	addMode = true;
	hightlight(savedChoice);
	document.getElementById("stopAddingButton").style.display = "block";
	document.getElementById("allExceptEditButton").style.display = "none";
	// get the last marker coordinates of the selected path
	tempRoute = route;
	route = 0;
	for(var i=0; i<markers.length; i++){
		if(markersPathIds[i] == savedChoice){
			markersArray.push(markers[i]);
		}
	}
	for(var i=0; i<markers.length; i++){
		if(markersPathIds[i] == savedChoice){
			lastMarker = i;
			tempMarkerPathId = markersPathIds[i];
		}
	}
	route = markersArray.length % 2 == 1 ? (markersArray.length-1)*2 : markersArray.length*2-2;
	var markersBeforePath = [];
	var inc = 0;
	nbOfMarkersBeforePath = 0;
	if(savedChoice > 0){
		// count the number of markers before the selected path
		while(inc < savedChoice){
			for(var i=0; i<polylines.length; i++){
				if(polylineIds[i] == inc){
					nbOfMarkersBeforePath+=2;
				}
			}
			inc++;
			nbOfMarkersBeforePath+=2;
		}
		route+=nbOfMarkersBeforePath;
	}
}
function stopAddMode(){
	bias = 0;
	addMode = false;
	hightlight(savedChoice);
	document.getElementById("stopAddingButton").style.display = "none";
	document.getElementById("allExceptEditButton").style.display = "block";
}
function stopEditMode(){
	editMode = false;
	hightlight(savedChoice);
	document.getElementById("stopEditingButton").style.display = "none";
	document.getElementById("allExceptEditButton").style.display = "block";
	if(savedChoice != -1){
		for(var i=0; i<markers.length; i++){
			if(markersPathIds[i] == savedChoice){
				markers[i].dragging.disable();
			}
		}
	}
}
var newRoute = false;
function createNewRoute(){
	newRoute = true;
	polylineId++;
	markerPathId++;
}
function showPathManagement(){
	var settingsDiv = document.getElementById("path-management");
	if (settingsDiv.style.display === "none") {
		settingsDiv.style.display = "block";
	} else {
		settingsDiv.style.display = "none";
	}
}

var currentRunningMarkers = []; // array with current running animated markers to check if the color of the markers can be changed, animated markers will be removed on end of the animation
// currentRunningMarkers can be improved so we can check marker by marker (but the function used in animatedMarkers.js onEnd (pop()) might not work)
function showSettings(){
	var settingsDiv = document.getElementById("settings");
	if (settingsDiv.style.display === "none") {
		settingsDiv.style.display = "block";
	} else {
		settingsDiv.style.display = "none";
	}
}
function changeSpeed(){
	var btnSimSpeed = document.getElementById("simSpeed");
	if(btnSimSpeed.innerHTML == "Slow"){
		btnSimSpeed.innerHTML = "Normal"; // Normal
		for(var m=0; m<animatedMarkers.length; m++){
			animatedMarkers[m].options.interval = 300;
		}
	} else if(btnSimSpeed.innerHTML == "Normal"){
		btnSimSpeed.innerHTML = "Fast"; // Fast
		for(var m=0; m<animatedMarkers.length; m++){
			animatedMarkers[m].options.interval = 100;
		}
	} else {
		btnSimSpeed.innerHTML = "Slow"; // Slow
		for(var m=0; m<animatedMarkers.length; m++){
			animatedMarkers[m].options.interval = 700;
		}
	}
}

var polylines = [];
var polylineId = 0;
var polylineIds = [];
function callApi(lng1, lat1, lng2, lat2, transportationMode){
	var client = new XMLHttpRequest();
	client.open("GET",
	"https://api.mapbox.com/directions/v5/mapbox/"+transportationMode+"/"+lng1+","+lat1+";"+lng2+","+lat2+"?geometries=geojson&access_token=pk.eyJ1IjoibGVvbHIiLCJhIjoiY2s5bXB1ZnUzMDZzZjNmbnR6OXVzemF0byJ9.MeB8qySF0KJn0WHkOOZj3Q"
	, true);
	client.onreadystatechange = function() {
		if(client.readyState == 4) {
			var polylinePoints = [];
			for(var i=0; i<JSON.parse(client.responseText).routes[0].geometry.coordinates.length; i++){
				var coords = JSON.parse(client.responseText).routes[0].geometry.coordinates[i];
				var longitude = JSON.stringify(coords).replace("[","").split(",")[0];
				var latitude = JSON.stringify(coords).replace("]","").split(",")[1];
				var latLngPoly = [];
				latLngPoly.push(latitude);
				latLngPoly.push(longitude);
				polylinePoints.push(latLngPoly);
			}
			if(editMode || addMode){
			polylines.push(L.polyline(polylinePoints).setStyle({
				color: "#13c242"
			}).addTo(map));
			} else {
			polylines.push(L.polyline(polylinePoints).addTo(map));
			}
			if(editMode || addMode){
				polylineIds.push(savedChoice);
				
			} else {
				polylineIds.push(polylineId);
			}
			editPathsList();
		};
	};
	client.send();
}

function changePathName(id){
	pathNames[id] = prompt("Please enter the new path name :");
	editPathsList();
}
function btn(){
	return '<button>Change Path Name</button>';
}
function editPathsList(){
	var pathId = 0;
	var t = $('#myTable').DataTable();
	t.clear().draw(true); // remove table rows
	for(var i=0; i<=polylineId; i++){
		if(!deletedPath){
			t.row.add([i,
			pathNames[i]+" "+btn(),
			// add nothing so defaultvalue will overrite and will add buttons
			]).draw(true);
			if(i == polylineId){
				test = false;
			}
		} else {
			deletedPath = false;
		}
	} 
}

var roundIcon = new L.Icon({
  iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/0/0e/Ski_trail_rating_symbol-green_circle.svg/480px-Ski_trail_rating_symbol-green_circle.svg.png',
  iconSize: [16, 16],
  iconAnchor: [8, 8],
  popupAnchor: [0, 0],
  shadowSize: [41, 41]
});


var selectId = 1;
var simulationBias = -1;
var markerNumber = 1;
var i=0;
var latLng = [];
var markers = [];
var markerPathId = 0;
var markersPathIds = [];
var route = 0;
var bias = 0;
var even = true;
function addPointer(){
	if(newRoute || markers.length == 0){
		var marker = L.marker([
		document.getElementById("info").innerHTML.split(",")[0],
		document.getElementById("info").innerHTML.split(",")[1]
		],{radius : 6, draggable : false}).addTo(map).bindPopup(lat+" "+lng);
	} else {
		var marker = L.marker([
		document.getElementById("info").innerHTML.split(",")[0],
		document.getElementById("info").innerHTML.split(",")[1]
		],{radius : 6, draggable : false, icon : roundIcon}).addTo(map).bindPopup(lat+" "+lng);
	}
	if(addMode){
		// add to a specific index, not at the end of the array
		latLng.splice(lastMarker*2+2+bias, 0, document.getElementById("info").innerHTML.split(",")[1]); // lng
		latLng.splice(lastMarker*2+2+bias, 0, document.getElementById("info").innerHTML.split(",")[0]); // lat
		// pushed lat, lng in array after the last marker
		markers.splice(lastMarker+1, 0, marker);
		markersPathIds.splice(lastMarker+1, 0, tempMarkerPathId);
		bias += 2;
	} else {
		latLng.push(document.getElementById("info").innerHTML.split(",")[0]);
		latLng.push(document.getElementById("info").innerHTML.split(",")[1]);
		markers.push(marker);
		markersPathIds.push(markerPathId);
	}
	if(i>0){
		traceRoute();
	}
	i = i+1;
}

var pathNumber = 1;
function traceRoute(){
		if(!newRoute){
			callApi(latLng[route+1], latLng[route], latLng[route+3], latLng[route+2], transportationMode);
		}
		if(newRoute || polylines.length == 0){
			pathNames.push("Path n¬∞"+pathNumber);
			pathNumber++;
			var option = document.createElement("option");
			option.text = "Change marker "+markerNumber+"'s icon";
			option.value = selectId;
			document.getElementById("marker-icon-select").add(option);
			selectId++;
			markerNumber++;
			newRoute = false;
		}
		route+=2;
}
		
var lat, lng;

map.addEventListener('mousemove', function(ev) {
   lat = ev.latlng.lat;
   lng = ev.latlng.lng;
   document.getElementById('info').innerHTML = lat +","+ lng;
});

var animatedMarkers = [];
var markersIconId = [];
var mergedRoutes = [];
function simulateTrajectory(){
	document.getElementById("simSpeed").innerHTML = "Normal";
	var uniqueArray = polylineIds.filter(function(item, pos) {
		return polylineIds.indexOf(item) == pos;
	})
	for(var ids = 0; ids < uniqueArray.length; ids++){
		var mergedRoute = [];
		for(var i = 0; i < polylines.length; i++){
			if(polylineIds[i] == ids){
				mergedRoute.push(polylines[i].getLatLngs());
			}
		}
		mergedRoute = mergedRoute.flat();
		if(mergedRoutes.length > 0){
			var routeIsntInArrayYet = true;
			for(var test = 0; test < mergedRoutes.length; test++){
				if(mergedRoutes[test].join() == mergedRoute.join()){
					routeIsntInArrayYet = false; // route is in array
				}
			}
			if(routeIsntInArrayYet){
				mergedRoutes.push(mergedRoute);
			}
		} else {
			mergedRoutes.push(mergedRoute);
		}
	}
	for(n=0; n<mergedRoutes.length; n++){
		var animatedMarker = L.animatedMarker(mergedRoutes[n]);
		map.addLayer(animatedMarker);
		animatedMarkers.push(animatedMarker);
		currentRunningMarkers.push(animatedMarker);
		markersIconId.push(0); // default icon is id 0
		simulationBias += 1;
	}
}

var redIcon = new L.Icon({
  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41]
});

var blueIcon = new L.Icon({
  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41]
});

var greenIcon = new L.Icon({
  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41]
});

function changeIcon(iconNumber){
	if(currentRunningMarkers.length != 0){
		animatedMarkers[iconNumber].setIcon(redIcon);
	} else {
		alert("Start the simulation before changing markers colors !");
	}
}

function changePathsColor(){
	if(polylines.length != 0){
		for(var i=0; i<polylines.length; i++){
			polylines[i].setStyle({
				color: document.getElementById("color-path-select").value
			});
		}
	}
	else {
		alert("Draw at least 1 path before changing path colors !");
	}
}
function changeMarkersColor(){
	if(currentRunningMarkers.length != 0){
		var selectedValue = document.getElementById("color-marker-select").value
		for(var i=0; i<animatedMarkers.length; i++){
			if(selectedValue == "blue" || selectedValue == "#3388ff"){
				animatedMarkers[i].setIcon(blueIcon);
			} else if(selectedValue == "red"){
				animatedMarkers[i].setIcon(redIcon);
			} else {
				animatedMarkers[i].setIcon(greenIcon);
			}
		}
	} else {
		alert("Start the simulation before changing markers colors !");
	}
}

var stringToDownload;
function downloadPaths(toGDrive = false){
	// create a string that will be converted into a JSON file : {"paths":[[{"id":0},{"coords":[[1,2]]}],[{"id":0},{"coords":[[1,2],[1,2]]}]]}
	var JSONstring = '';
	JSONstring+='{"paths":[';
	for(var i=0; i<polylines.length; i++){ // for each polyline
		JSONstring+='[';
		var polyId = polylineIds[i] // id of the current polyline
		var currentCoords = polylines[i].getLatLngs(); // latLngs of the current polyline
		JSONstring+='{"id":'+polyId+'},{"coords":[';
		for(var j=0; j<currentCoords.length; j++){
			JSONstring+='[';
			JSONstring+=currentCoords[j].lat+','+currentCoords[j].lng;
			JSONstring+=']';
			if(j!=currentCoords.length-1){
				JSONstring+=',';
			}
		}
		JSONstring+=']}]';
		if(i!=polylines.length-1){
			JSONstring+=',';
		}
	}
	JSONstring+=']}';
	if(toGDrive == false){
		stringToDownload = JSON.parse(JSONstring);
		// usage to get a coordinate or an id : stringToDownload['paths'][pathId][0 for id, 1 for coords]['coords' or 'id'][index if coords]
		// download locally
		downloadObjectAsJson(stringToDownload, 'paths-'+new Date().toLocaleDateString()+"-"+new Date().getHours()+":"+new Date().getMinutes()+":"+new Date().getSeconds());
	} else {
		stringToDownload = JSONstring;
	}
}

function downloadObjectAsJson(exportObj, exportName){
    var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj));
    var downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", exportName + ".json");
    document.body.appendChild(downloadAnchorNode); // required for firefox
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
}
</script>
</body>
</html>